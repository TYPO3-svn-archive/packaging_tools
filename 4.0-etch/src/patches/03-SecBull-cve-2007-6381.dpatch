#!/bin/sh /usr/share/dpatch/dpatch-run
## 02-SecBull-20070221-1.dpatch by Christian Welzel <gawain@camlann.de>
##
## DP: fix for TYPO3 Security Bulletin 20070221-1: Email header injection

@DPATCH@

diff -Naur TYPO3_4-0-7/typo3/sysext/indexed_search/modfunc2/class.tx_indexedsearch_modfunc2.php TYPO3_4-0-8/typo3/sysext/indexed_search/modfunc2/class.tx_indexedsearch_modfunc2.php
--- TYPO3_4-0-7/typo3/sysext/indexed_search/modfunc2/class.tx_indexedsearch_modfunc2.php	2006-03-22 02:11:50.000000000 +0100
+++ TYPO3_4-0-8/typo3/sysext/indexed_search/modfunc2/class.tx_indexedsearch_modfunc2.php	2007-12-10 19:51:50.000000000 +0100
@@ -86,10 +86,10 @@
 	 * @return	string		html table with results
 	 */
 	function showStats()	{
-		global $LANG,$HTTP_GET_VARS,$TYPO3_CONF_VARS;
+		global $LANG, $TYPO3_CONF_VARS;
 
 		$conf['words']=50;	// max words in result list
-		$conf['bid']=$HTTP_GET_VARS['id'];	// pageid for several statistics
+		$conf['bid'] = intval(t3lib_div::_GET('id'));	// pageid for several statistics
 
 		$addwhere1='';	// all records
 		$addwhere2=' AND tstamp > '.(time()-30*24*60*60);	// last 30 days
@@ -123,7 +123,7 @@
 
 		$queryParts['SELECT']= '*, COUNT(*) AS c';
 		$queryParts['FROM']='index_stat_word';
-		$queryParts['WHERE']=sprintf('pageid= %s '.$addwhere, $conf['bid']);
+		$queryParts['WHERE']=sprintf('pageid= %d '.$addwhere, $conf['bid']);
 		$queryParts['GROUPBY']='word';
 		$queryParts['ORDERBY']='c DESC,word';
 		$queryParts['LIMIT']=$conf['words'];
